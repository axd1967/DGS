# Topic: Quick-Suite
# Description: Alternative interface to DGS operations
# FAQ (robot-interface): http://www.dragongoserver.net/faq.php?read=t&cat=215#Entry219
# Author: Jens-Uwe Gaspar, DGS 'juga'

## /*
## Dragon Go Server
## Copyright (C) 2001-2010  Erik Ouchterlony, Jens-Uwe Gaspar
##
## This program is free software: you can redistribute it and/or modify
## it under the terms of the GNU Affero General Public License as
## published by the Free Software Foundation, either version 3 of the
## License, or (at your option) any later version.
##
## This program is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU Affero General Public License for more details.
##
## You should have received a copy of the GNU Affero General Public License
## along with this program.  If not, see <http://www.gnu.org/licenses/>.
## */


Topics:

   1. Introduction
   2. Login, Request and Response
   3. Objects
      a. "game" - playing a started game
   4. Classes and Files
   5. Possible Future Enhancements


#-------- (1) Introduction ----------------------------------------------------

The Quick-Suite provides an alternative interface to the DGS objects and operations.
It accepts generic-formatted input and results in a JSON-formatted output.

DGS "objects" represent different sections of the server:

   - user         : users, contacts, player, profile
   - game-offer   : waitingroom, invitation
   - game         : playing game
   - message
   - forum        : forums, threads, posts
   - help         : FAQ

Each "object" has a different set of "commands", than can be executed to get
information about the "object" or perform operations on the "object".



#-------- (2) Login, Request and Response -------------------------------------

A "command" is sent to the server via a GET or POST HTTP-request. The response is
sent back with MIME-type "application/json" and contains the respective result
for the requests command. The quick-script always expects a login-cookie in the
HTTP-headers, which can be created with:

   login.php?quick_mode=1&userid=HANDLE&passwd=PASSWORD


The standard request format looks like:

   quick_do.php?obj=<OBJNAME>&cmd=<COMMAND>&arg=...


The standard minimal response is a JSON-formatted text with an error-code,
there can be an optional 'error_msg' element:

   {
      "error": "error_code",
      "error_msg": "error message"
   }

An empty 'error_code' indicates a successful operation, i.e. no errors have occured:

   {
      "error": ""
   }

The response may contain additional object- and command-specific return-values.

   {
      "error": "",
      "Output1": ... ,
      "Output2": ...
   }


References:
   * JSON - RFC 4627 - The application/json Media Type for JavaScript Object Notation (JSON)
     http://tools.ietf.org/html/rfc4627
     http://en.wikipedia.org/wiki/Json


#-------- (3) Objects ---------------------------------------------------------

The currently supported DGS "objects" are:

   a) "game" - playing a started game

#-------- (3a) Objects - "game" -----------------------------------------------

Request:

   quick_do.php?obj=game&cmd=<COMMAND>&gid=<GAME_ID>&ctx=<CONTEXT>&move=<MOVES>&msg=<MESSAGE>

Options:

   <COMMAND> = "delete" | "set_handicap" | "move" | "resign" | "score"

   <GAME_ID> = integer
      - reference game to perform game-operation on

   <CONTEXT> = context
      - context = current move-number,
        providing context for game-operation to avoid errorneous states:
        - (a) multi-players account with simultaneous logins or
        - (b) (duplicate move commitment) if one player hit twice the validation button
          during a net lag, and/or
        - (c) if the opponent had already played between the two calls

   <MOVES> = move | moves | "pass"
      - move = single move-coordinate in specified mode-format
      - moves = list of coordinates in specified mode-format in comma-separated string,
        e.g. "bc,pq,mo,eq" (sgf) or "b17,q3,n5,e3" (lab)

      - there are two mode-formats:
          - moves are given in SGF-coordinates, e.g. "bc",
            specified in http://www.red-bean.com/sgf/go.html

          - moves are given in board-coordinates (labels), e.g. "b17"
            be aware, that board-coordinates skip the 'i'-character

   <MESSAGE> = message
      - optional game-message on game-operation


Commands:

   "delete" : deletes specified game
      - required opts: GAME_ID, CONTEXT
      - optional opts: MESSAGE

   "set_handicap" : sets handicap stones at start of game
      - required opts: GAME_ID, CONTEXT, MOVE
         - MOVE = moves : list of coordinates of the handicap-stone placement
      - optional opts: MESSAGE

   "move" :
      - required opts: GAME_ID, CONTEXT, MOVES
         - MOVES = move : single move to submit, move="pass" for passing move
      - optional opts: MESSAGE

   "resign" : resigns specified game
      - required opts: GAME_ID, CONTEXT
      - optional opts: MESSAGE

   "score" :
      - required opts: GAME_ID, CONTEXT, MOVE
         - MOVE = moves : list of coordinates of stones marked as dead
      - optional opts: MESSAGE


Possible errors:
   "" : operation successful

   //TODO Known errors from current implementation 'confirm.php' and 'quick_play.php':
   //TODO => adjust it for new 'quick_do.php'
      # errors from (old) 'quick_play.php'
      already_played
      database_corrupted
      game_finished
      game_not_started
      illegal_position
      internal_error
      invalid_action
      login_denied
      move_problem
      mysql_insert_move
      mysql_query_failed
      mysql_update_game
      no_game_nr
      not_logged_in
      not_your_turn
      unknown_game

      # additional errors from 'confirm.php'
      confirm_add_time
      early_pass
      mysql_insert_message
      opponent_not_found
      wrong_number_of_handicap_stone

---
   mysql_query_failed   - db load error
   login_denied - login denied
   fever_vault - login
   receiver_not_found - login, on sending msg
   internal_error - login, on sending msg
   mysql_insert_message - login, on sending msg
   mail_failure - login, on sending mail
   server_down

   invalid_command
   invalid_args
   unknown_game
   game_not_started
   game_finished

Examples of game-playing cycle:

   # login
   login.php?quick_mode=1&userid=user&passwd=userpassword

   # retrieve list of games to play in
   quick_status.php
   quick_status.php?user=user
   quick_status.php?uid=123

   # download game with moves, marked-dead-stones (MA-property), game-parameters
   sgf.php?gid=12345&owned_comments=1&quick_mode=1


   # setting handicap stones
   quick_do.php?obj=game&cmd=set_handicap&gid=12345&ctx=0&move=q16,b4&msg=Onegaishimasu

   # regular (first) move
   quick_do.php?obj=game&cmd=move&gid=12345&ctx=0&move=q3

   # regular move
   quick_do.php?obj=game&cmd=move&gid=12345&ctx=1&move=c17

   # pass moves
   quick_do.php?obj=game&cmd=move&gid=12345&ctx=2&move=pass
   quick_do.php?obj=game&cmd=move&gid=12345&ctx=3&move=pass

   # scoring-phase
   quick_do.php?obj=game&cmd=score&gid=12345&ctx=4&move=q16,d4
   quick_do.php?obj=game&cmd=score&gid=12345&ctx=5&move=c17,q3

   # resume playing (on disagreement)
   quick_do.php?obj=game&cmd=move&gid=12345&ctx=5&move=r14

   # resign
   quick_do.php?obj=game&cmd=resign&gid=12345&ctx=6


   # delete (only on first 10 moves)
   quick_do.php?obj=game&cmd=delete&gid=12345&ctx=6


#-------- (4) Classes and Files -----------------------------------------------

This section shortly describes the framework-classes and files in use.
For more details you may also check the source-code documentation of the classes,
their variables and functions.

   - quick_do.php:
     Facade to quick-suite to delegate commands on objects to quick-handlers.

   - include/quick/...
     Containing all quick-handlers.


#-------- (5) Possible Future Enhancements ------------------------------------
# Priority (1=high, 5=low, ?=unknown) is added, e.g. Prio(1)

This section outlines some ideas that came to mind regarding the quick-suite,
but are not necessarily going to be implemented (soon or at all).


* Prio(?): add more handlers for remaining DGS objects and operations


