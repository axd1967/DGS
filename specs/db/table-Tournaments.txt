###
### Description of mysql tables:  Tournament
###

Here you'll find some infos about all the tournament tables.

Legend:
   - T  = Tournament
   - TD = Tournament Director
   - TP = Tournament Participant (registered player)

Important Notes:
   - Guests can NOT perform "writing" operations for Ts
   - Admin can edit all Ts
   - Admin can set T-status at any time to any status
   - Admin and T-owner can add, delete & edit all TDs of a T
   - All TDs can edit their T


###########################################################################
## --- Tournament ---

Description:
   Tournament-management-data with scope, type, status, owner, dates
   and description.

 Field        | Type                                           | Default
--------------+------------------------------------------------+---------------------
 ID           | int(11)                                        | NULL, auto_increment
 Scope        | enum('DRAGON','PUBLIC','PRIVATE')              | PUBLIC
 Type         | enum('ROUNDROBIN')                             | ROUNDROBIN
 Title        | varchar(255)                                   |
 Description  | text                                           | NULL
 Owner_ID     | int(11)                                        | 0
 Status       | enum('ADM','NEW','REG','PAIR','PLAY','CLOSED') | NEW
 Flags        | smallint(5) unsigned                           | 0
 Created      | datetime                                       | 0000-00-00 00:00:00
 Lastchanged  | datetime                                       | 0000-00-00 00:00:00
 ChangedBy    | varchar(54)                                    |
 StartTime    | datetime                                       | 0000-00-00 00:00:00
 EndTime      | datetime                                       | 0000-00-00 00:00:00
 Rounds       | int(11)                                        | 1
 CurrentRound | int(11)                                        | 1


## Fields:

* Scope :
   - DRAGON = tournament sponsored by Dragon-server, official Dragon tourney,
     can only be "started" by DGS-admins
   - PUBLIC = public tournament, can be created by every DGS-user, open to everyone
   - PRIVATE = private tournament, registration only with token or by TD-invitation

* Type : Tournament-type
   - ROUNDROBIN = TPs playing in pooled rounds
   - future: LADDER = TP can "climb" up ladder (=KING-OF-THE-HILL)
   - future: LEAGUE = Team-tournaments

* Title : name of the T

* Description : description of the T

* Owner_ID : Players.ID of the T-creator

* Status : current process-state of the T
   - ADM = reserved state (to migrate old Ts)
   - NEW = freshly created T (needs setup)
   - REG = registration-period can start
   - PAIR = pairing for next round starts
   - PLAY = pairing finished, games are started automatically,
     TPs play until all games are finished
   - CLOSED = T finished

* Flags : bitmask with tournament-flags
   - values defined in 'tournaments/include/tournament_globals.php' as TOURNEY_FLAG_...,
     also see descriptions in 'tournaments/include/tournament.php' getFlagsText()-func
   - 0x0001 (=LOCK_ADMIN):
      - prohibits all read-write ops on tourney for non-TAdmins:
         - prohibits user to all register-ops, challenge/retreat on ladder
         - prohibits TD/owner to edit-tourney/director/props/rules/rounds/participants/locks/status, game-admin
         - prohibits TD/owner to edit-ladder-props, admin/edit-ladder
         - prohibits cron from processing for locked tourney
   - 0x0002 (=LOCK_REGISTER):
      - prohibits user to join tournament by apply/register/ack-invite or edit-registration
   - 0x0004 (=LOCK_TDWORK): lock for (some) work of TD
      - prohibits cron (having less prio than tdwork-lock)
      - stop cron for current tourney with set ladder-lock
      - prohibits user to join tournament by apply/register/ack-invite or edit-registration
      - prohibits user to challenge/retreat on ladder
      - needed to allow TD/owner/admin to admin/edit-ladder
   - 0x0008 (=LOCK_CRON):
      - can block some ops to admin/edit tournament for TD/Owner/Admin (e.g. for ladder)
   - 0x0010 (=LOCK_CLOSE): prepares tournament for transition to CLOSED-status
      - prohibits user to join tournament
      - prohibits TD/owner to edit-registration
      - for ladder: prohibits user to challenge/retreat

* Created : date of creation of T

* Lastchanged : date of last-update of T (on Status, Name, Description, Start/EndTime)

* ChangedBy : handle-list of users, that last changed data-row in format '[last-user] [prev-user] ...'

* StartTime : official start-date of T (informal)

* EndTime : datetime when T closed, T can be changed afterwards still by TDs

* Rounds, CurrentRound : number of rounds, current round-number of T


###########################################################################
## --- TournamentDirector ---

Description:
   List of TDs for tournament with additional flags and comment about TD.

 Field   | Type                 | Default
---------+----------------------+--------
 tid     | int(11)              | NULL
 uid     | int(11)              | NULL
 Flags   | smallint(5) unsigned | 0
 Comment | varchar(255)         |

## Fields:

* tid, uid : primary key of this table
   - Existing DB-entry makes User [uid] a TD for T [tid]

* Flags : bitmask with flags for TD
   - 0x0001 = TD_FLAG_GAME_END = TD is allowed to end tournament-game prematurely,
     (only when on TournamentGames.Status=PLAY)
   - 0x0002 = TD_FLAG_GAME_ADD_TIME = TD is allowed to add time
     to players of tournament-game as long as game is running

* Comment : public comment about TD, may be empty


###########################################################################
## --- TournamentParticipant ---

Description:
   list with TPs of tournament and user-specific tournament data


 Field        | Type                              | Default
--------------+-----------------------------------+---------------------
 ID           | int(11)                           | NULL, auto_increment
 tid          | int(11)                           | NULL
 uid          | int(11)                           | NULL
 Status       | enum('APPLY','REGISTER','INVITE') | APPLY
 Flags        | smallint(5) unsigned              | 0
 Rating       | double                            | -9999
 StartRound   | tinyint(3) unsigned               | 1
 Created      | datetime                          | 0000-00-00 00:00:00
 Lastchanged  | datetime                          | 0000-00-00 00:00:00
 ChangedBy    | varchar(54)                                    |
 Comment      | varchar(60)                       |
 Notes        | text                              | NULL
 UserMessage  | text                              | NULL
 AdminMessage | text                              | NULL


## Fields:

* tid, uid : tournament-ID and user-id, that registers
   - Existing DB-entry makes User [uid] a candidate for participating in the T [tid]
   - User can register himself on non-private Ts
   - User can be invited by TD

* Status :
   - APPLY = user applied for T, but needs to be verified by TD,
     TD can approve or reject application of user
   - REGISTER = user is registered, can be unregistered by user or TD
   - INVITE = user is invited, user need to approve or reject invitation

   - State-Transitions for TD & User:
      - INIT = not registered to T
      - Edit-C = edit customized fields
      - Edit-M = edit non-customized fields like messages, comment
      - Edit-All = edit all fields
      - "<OLD-STATE> ---[action]---> <NEW-STATE>"

      - State-Transitions for User:

            INIT  ---[apply]---------> APPLY    (customized registration)
            APPLY ---[EDIT-All]------> APPLY
            APPLY ---[remove]--------> INIT

            INIT     ---[register]---> REGISTER (matching T-restrictions, no customization)
            REGISTER ---[EDIT-C]-----> APPLY
            REGISTER ---[EDIT-M]-----> REGISTER
            REGISTER ---[remove]-----> INIT

            INVITE ---[EDIT-C]-------> APPLY
            INVITE ---[ACK-Invite]---> REGISTER
            INVITE ---[remove]-------> INIT

      - State-Transitions for TD:

            INIT   ---[invite]-----> INVITE       [ + notify ]
            INVITE ---[EDIT-All]---> INVITE
            INVITE ---[remove]-----> INIT         [ + notify ]

            APPLY ---[ACK-Apply]---> REGISTER     [ + notify ]
            APPLY ---[EDIT-C]------> INVITE       [ + notify ]
            APPLY ---[EDIT-M]------> APPLY
            APPLY ---[remove]------> INIT         [ + notify ]

            REGISTER ---[EDIT-C]---> INVITE       [ + notify ]
            REGISTER ---[EDIT-M]---> REGISTER
            REGISTER ---[remove]---> INIT         [ + notify ]

* Flags :
   - additional properties of registered user:
      - INVITED (by TD)
      - VERIFIED (by TD)
      - INVITE_ACK (by user after invitation)
      - APPLY_ACK (by TD after verifying application)
      - future: LOCK (user blocked/locked by TD for arbitrary reason)

* Rating : Rating used for T, depends on TournamentProperties.RatingUseMode

* StartRound : Round user wants to start in for T

* Created : date of initial application/registration/invitation for T

* Lastchanged : date of last-update on TP

* ChangedBy : handle-list of users, that last changed data-row in format '[last-user] [prev-user] ...'

* Comment : public comment from user

* Notes : private notes for TDs about user

* UserMessage : private message from user to TD

* AdminMessage : private message from TD to user


###########################################################################
## --- TournamentProperties ---

Description:
   List of properties of a tournament, that influences registration process.

 Field                | Type                                                  | Default
----------------------+-------------------------------------------------------+---------------------
 tid                  | int(11)                                               | NULL
 Lastchanged          | datetime                                              | 0000-00-00 00:00:00
 ChangedBy            | varchar(54)                                           |
 MinParticipants      | smallint(6)                                           | 0
 MaxParticipants      | smallint(6)                                           | 0
 RatingUseMode        | enum('COPY_CUSTOM','CURR_FIX','COPY_FIX')             | COPY_CUSTOM
 RegisterEndTime      | datetime                                              | 0000-00-00 00:00:00
 UserMinRating        | double                                                | -9999
 UserMaxRating        | double                                                | -9999
 UserRated            | enum('N','Y')                                         | N
 UserMinGamesFinished | smallint(6)                                           | 0
 UserMinGamesRated    | smallint(6)                                           | 0
 Notes                | text                                                  | NULL


## Fields:

* tid : tournament-ID

* Lastchanged : update of table-entry

* ChangedBy : handle-list of users, that last changed data-row in format '[last-user] [prev-user] ...'

* MinParticipants, MaxParticipants : minimum / maximum number of TPs
   - 0 = no limits

* RatingUseMode : mode to handle tournament-rating on registration (and tournament playing)
   - COPY_CUSTOM = copies existing user-rating for T-rating,
     but allow user to overwrite it (customizable)
   - CURR_FIX = always use current DGS-rating during T,
     no customization of rating allowed by TD or user
   - COPY_FIX = copies exising user-rating for T-rating,
     can't be changed afterwards by user (fix = not customizable)

* RegisterEndTime : datetime for end of registration-phase

* UserMinRating, UserMaxRating : minimum / maximum rating of TPs
   - -9999 = not limited
   - is not used, if UserRated='N'

* UserRated :
   - Y = user must have a rating on registering
   - N = user need no rating on registering

* UserMinGamesFinished, UserMinGamesRated :
   - minimum number of finished / rated-finished games of TPs
   - 0 = no limits

* Notes : additional Notes to be shown for registration-section


###########################################################################
## --- TournamentRules ---

Description:
   Game settings for tournament.

 Field        | Type                                    | Default
--------------+-----------------------------------------+---------------------
 ID           | int(11)                                 | NULL
 tid          | int(11)                                 | NULL
 Lastchanged  | datetime                                | 0000-00-00 00:00:00
 ChangedBy    | varchar(54)                             |
 Flags        | smallint(5) unsigned                    | 0
 Size         | int(11)                                 | 19
 Handicaptype | enum('CONV','PROPER','NIGIRI','DOUBLE','BLACK','WHITE') | CONV
 AdjKomi      | decimal(6,1)                             | 0.0
 JigoMode     | enum('KEEP_KOMI','ALLOW_JIGO','NO_JIGO') | KEEP_KOMI
 Handicap     | int(11)                                 | 0
 Komi         | decimal(6,1)                            | 6.5
 AdjHandicap  | tinyint(4)                              | 0
 MinHandicap  | tinyint(4)                              | 0
 MaxHandicap  | tinyint(4)                              | 127
 StdHandicap  | enum('N','Y')                           | N
 Maintime     | int(11)                                 | 0
 Byotype      | enum('JAP','CAN','FIS')                 | JAP
 Byotime      | int(11)                                 | 0
 Byoperiods   | int(11)                                 | 0
 WeekendClock | enum('N','Y')                           | Y
 Rated        | enum('N','Y')                           | N
 Notes        | text                                    | NULL

## Fields:

* tid : tournament-ID

* Lastchanged : update of table-entry

* ChangedBy : handle-list of users, that last changed data-row in format '[last-user] [prev-user] ...'

* Flags : not-used

* Size : board-size in range 5..25

* Handicaptype :
   - CONV = conventional handicap
   - PROPER = proper handicap
   - NIGIRI = even game with nigiri
   - BLACK | WHITE =
     - ladder-tournament:      manual game with challenger getting black | white
     - round-robin-tournament: manual game with stronger player getting black | white
   - DOUBLE = double game (not supported yet)
   - in relation to Waitingroom-table noted enums in upper-case

* AdjKomi : TODO

* JigoMode : TODO
   enum('KEEP_KOMI','ALLOW_JIGO','NO_JIGO')

* Handicap : number of handicap stones

* Komi : komi

* AdjHandicap, MinHandicap, MaxHandicap :
   - Handicap-stone adjustment after applying handicap-type
   - like in waiting-room but with less settings

* StdHandicap : standard-placement of handicap-stones
   - Y = use standard-placement
   - N = otherwise

* Maintime, Byotype, Byotime, Byoperiods :

* WeekendClock :
   - Y = use weekend-clock
   - N = otherwise

* Rated :
   - Y = games played in T do adjust rating of TPs, need rated user
   - N = otherwise

* Notes : additional Notes to be shown for tournament-rules


###########################################################################
## --- TournamentRound ---

Description:
   Pool-setup for one tournament round.

 Field       | Type                                                 | Default
-------------+------------------------------------------------------+---------------------
 tid         | int(11)                                              | NULL
 Round       | int(11)                                              | NULL
 RulesID     | int(11)                                              | NULL
 Lastchanged | datetime                                             | 0000-00-00 00:00:00
 Status      | enum('INIT','POOLINIT','PAIRINIT','GAMEINIT','DONE') | INIT
 MinPoolSize | smallint(5)                                          | 0
 MaxPoolSize | smallint(5)                                          | 0
 PoolCount   | smallint(5)                                          | 0

## Fields:

* tid : tournament-ID

* Round : round number

* RulesID : FK to TournamentRules.ID

* Lastchanged : update of table-entry

* Status : pairing status for tournament round
   - INIT = new round started, no setup yet
   - POOLINIT = new pools created (empty)
   - PAIRINIT = TPs assigned to pool
   - GAMEINIT = T-games setup, ready to be created and started
   - DONE = pairing for tournament round is done

* MinPoolSize, MaxPoolSize : min. and max. size of pools for tournament round

* PoolCount : TODO


###########################################################################
## --- TournamentLadder ---

Description:
   Table to keep track of ladder of ladder-typed tournaments.

 Field         | Type                 | Default
---------------+----------------------+---------------------
 tid           | int(11)              | NULL
 rid           | int(11)              | NULL
 uid           | int(11)              | NULL
 Created       | datetime             | 0000-00-00 00:00:00
 RankChanged   | datetime             | 0000-00-00 00:00:00
 Rank          | smallint(5) unsigned | 0
 BestRank      | smallint(5) unsigned | 0
 ChallengesIn  | tinyint(3) unsigned  | 0
 ChallengesOut | tinyint(3) unsigned  | 0

## Fields:

* tid : FK to Tournament.ID

* rid : FK to TournamentParticipant.ID

* uid : FK to TournamentParticipant.uid (=redundant with rid, added for faster-access)

* Created : start-date of user in ladder

* RankChanged : date of last rank-changed caused by direct win or loss of user
   - not updated if leap-frogged by other TPs

* Rank : current ladder-rank (=position) for user

* BestRank : maximum of reached ladder-ranks for user caused by direct win or loss
   - defaults to Rank

* ChallengesIn : number of current incoming challenges for ladder-user

* ChallengesOut : number of current outgoing challenges for ladder-user


###########################################################################
## --- TournamentLadderProps ---

Description:
   Table for ladder-specific tournament properties.

 Field                  | Type                 | Default
------------------------+----------------------+---------------------
 tid                    | int(11)              | NULL
 Lastchanged            | datetime             | 0000-00-00 00:00:00
 ChangedBy              | varchar(54)          |
 ChallengeRangeAbsolute | smallint(5)          | 0
 ChallengeRangeRelative | tinyint(3) unsigned  | 0
 ChallengeRangeRating   | smallint(6)          | -32768
 ChallengeRematchWait   | smallint(5) unsigned | 0
 MaxDefenses            | tinyint(3) unsigned  | NULL
 MaxDefenses1           | tinyint(3) unsigned  | 0
 MaxDefenses2           | tinyint(3) unsigned  | 0
 MaxDefensesStart1      | tinyint(3) unsigned  | 0
 MaxDefensesStart2      | tinyint(3) unsigned  | 0
 MaxChallenges          | tinyint(3) unsigned  | 0
 GameEndNormal          | enum('CH_ABOVE','CH_BELOW','SWITCH','DF_BELOW','DF_LAST')                      | CH_ABOVE
 GameEndJigo            | enum('NO_CHANGE','CH_ABOVE','CH_BELOW')                                        | CH_BELOW
 GameEndTimeoutWin      | enum('NO_CHANGE','CH_ABOVE','CH_BELOW','SWITCH','DF_BELOW','DF_LAST','DF_DEL') | DF_BELOW
 GameEndTimeoutLoss     | enum('NO_CHANGE','CH_LAST','CH_DEL')                                           | CH_LAST


## Fields:

* tid : FK to Tournament.ID

* Lastchanged : date of last update of table-entry

* ChangedBy : user-list that updated table-entry in format: "[user2] [user1] ..."

* ChallengeRangeAbsolute :
   - number of rank-positions a ladder-user can challenge users above own position
   - -1 = no limit, challenger can challenge all users above own position
   -  0 = unused option, i.e. other challenge ranges must configure challenge-range

* ChallengeRangeRelative :
   - percentage of ladder-users above current pos that can be challenged
   - 0 = unused option, i.e. other challenge ranges must configure challenge-range

* ChallengeRangeRating :
   - challenge-range is [ChallengeRangeRating] ranks down from theoretical position
     in laddered ordered by user/tourney-rating
     - Example:
       - rank of 1dans on ladder is 7, user-rating is 1dan, ChallengeRangeRating=5
       - Then user can challenge ladder-users up to rank 12 (=7+5).
   - value = -32768 : unused option,
     i.e. other challenge ranges must configure challenge-range

* ChallengeRematchWait : how many hours to wait till rematch same user
   - 0 = unused, challenger can immediately rematch same user
   - >0 = hours to wait before a rematch with same user

* MaxDefenses : default max. number of defenses
* MaxDefenses1 : max. number of defenses for 1st rank-group
* MaxDefenses2 : max. number of defenses for 2nd rank-group
* MaxDefensesStart1 : start-rank for MaxDefenses1 (counting up) for 1st rank-group
* MaxDefensesStart2 : start-rank for MaxDefenses2 (counting up) for 2nd rank-group
   - There can be 3 groups of different max-defenses. Example:
      - restrict ranks 1..5 to 5 games, ranks 6..10 to 4 games, other ranks to 3 games
        MaxDefenses1=5, MaxDefensesStart1=5,
        MaxDefenses2=4, MaxDefensesStart1=10,
        MaxDefenses=3
   - With 2 rank-groups MaxDefenses2,Start2=0
   - With 1 rank-groups MaxDefenses1/2,Start1/2=0
   - There must be a default limitation > 0
   - rank-groups1/2 restrictions are optional => use 0 = not-used

* MaxChallenges : max. number of outgoing challenges (for challenger)
   - 0 = unlimited

* GameEndNormal : normal handling on game-end when challenger wins over defender
   - default = CH_ABOVE
   - Enum-values subset: see tournaments/include/tournament_globals.php

* GameEndJigo : handling of game-end with jigo
   - default = CH_BELOW
   - Enum-values subset: see tournaments/include/tournament_globals.php

* GameEndTimeoutWin : handling of game-end when challengers wins by timeout (=defender loses by timeout)
   - default = DF_BELOW
   - Enum-values: see tournaments/include/tournament_globals.php

* GameEndTimeoutLoss : handling of game-end when challengers loses by timeout (=defender wins by timeout)
   - default = CH_LAST
   - Enum-values: see tournaments/include/tournament_globals.php


###########################################################################
## --- TournamentGames ---

Description:
   Table to keep track of tournament-games.

 Field          | Type                       | Default
----------------+----------------------------+---------------------
 ID             | int(11)                    | NULL
 tid            | int(11)                    | NULL
 gid            | int(11)                    | 0
 Status         | enum('INIT','PLAY','SCORE','WAIT','DONE') | INIT
 TicksDue       | int(11)                    | 0
 Flags          | smallint(5) unsigned       | 0
 Lastchanged    | datetime                   | 0000-00-00 00:00:00
 ChangedBy      | varchar(54)                |
 Challenger_uid | int(11)                    | NULL
 Challenger_rid | int(11)                    | NULL
 Defender_uid   | int(11)                    | NULL
 Defender_rid   | int(11)                    | NULL
 StartTime      | datetime                   | 0000-00-00 00:00:00
 EndTime        | datetime                   | 0000-00-00 00:00:00
 Score          | decimal(5,1)               | 0.0


## Fields:

* tid : FK to Tournament.ID

* gid : FK to Games.ID, 0 = unset yet

* Status : status for Tournament-game
   - INIT = Tournament-game scheduled, need to be started
   - PLAY = Tournament-game is being played by challenger and defender
   - SCORE = Tournament-game has ended by score/resign/jigo/timeout and
     needs processing for tournament
   - WAIT = mark Tournament-game for rematch-waiting with same user,
     see TicksDue-field
   - DONE = Tournament-game is finished and results booked in tournament

* TicksDue : half-hour due-ticks to keep track of rematch-lock
   - has meaning only if status=WAIT
   - TicksDue contains the absolute half-hour-ticks when the status is changed
     to DONE to allow rematch of challenger and defender

* Flags : flags

* Lastchanged : date of last update of table-entry

* ChangedBy : user-list that updated table-entry in format: "[user2] [user1] ..."

* Challenger_uid : FK to Players.ID for challenger
* Challenger_rid : FK to TournamentParticipant.ID = TournamentLadder.rid

* Challenger_uid : FK to Players.ID for defender
* Challenger_rid : FK to TournamentParticipant.ID = TournamentLadder.rid

* StartTime : like Games.Startime

* EndTime : like Games.Lastchanged when game finished

* Score : similar to Games.Score but meaning is oriented on challenger/defender-roles
   - 0 = unset yet, only for INIT/PLAY-status

   - set for SCORE/DONE-status:
      - 0 = jigo
      - -1000, 1000 = Challenger(-1000)/Defender(1000) has won game by resignation
      - -2000, 2000 = Challenger(-2000)/Defender(2000) has won game by timeout


